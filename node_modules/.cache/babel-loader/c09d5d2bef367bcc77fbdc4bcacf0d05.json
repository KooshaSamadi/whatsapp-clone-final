{"ast":null,"code":"var _jsxFileName = \"C:\\\\Users\\\\Koosha\\\\Desktop\\\\Reed Barger - Build WhatsApp with React 2021-5\\\\whatsapp-clone\\\\src\\\\components\\\\Chat.js\",\n    _s = $RefreshSig$();\n\nimport React from \"react\";\nimport { useHistory, useParams } from \"react-router-dom\";\nimport \"./Chat.css\";\nimport useRoom from \"../hooks/useRoom\";\nimport ChatMessages from \"./ChatMessages\";\nimport ChatFooter from \"./ChatFooter\";\nimport MediaPreview from \"./MediaPreview\";\nimport Compressor from \"compressorjs\";\nimport { Avatar, CircularProgress, IconButton, Menu, MenuItem } from \"@material-ui/core\";\nimport { AddPhotoAlternate, ArrowBack, MoreVert } from \"@material-ui/icons\";\nimport { v4 as uuid } from \"uuid\";\nimport { audioStorage, createTimestamp, db, storage } from \"../firebase\";\nimport useChatMessages from \"../hooks/useChatMessages\";\nimport { jsxDEV as _jsxDEV } from \"react/jsx-dev-runtime\";\nexport default function Chat({\n  user,\n  page\n}) {\n  _s();\n\n  const [image, setImage] = React.useState(null);\n  const [input, setInput] = React.useState(\"\");\n  const [isDeleting, setDeleting] = React.useState(false);\n  const [openMenu, setOpenMenu] = React.useState(null);\n  const [src, setSrc] = React.useState(\"\");\n  const [audioId, setAudioId] = React.useState(\"\");\n  const {\n    roomId\n  } = useParams();\n  const history = useHistory();\n  const messages = useChatMessages(roomId);\n  const room = useRoom(roomId, user.uid);\n\n  function onChange(event) {\n    setInput(event.target.value);\n  }\n\n  async function sendMessage(event) {\n    event.preventDefault();\n\n    if (input.trim() || input === \"\" && image) {\n      setInput(\"\");\n\n      if (image) {\n        closePreview();\n      }\n\n      const imageName = uuid();\n      const newMessage = image ? {\n        name: user.displayName,\n        message: input,\n        uid: user.uid,\n        timestamp: createTimestamp(),\n        time: new Date().toUTCString(),\n        imageUrl: \"uploading\",\n        imageName\n      } : {\n        name: user.displayName,\n        message: input,\n        uid: user.uid,\n        timestamp: createTimestamp(),\n        time: new Date().toUTCString()\n      };\n      db.collection(\"users\").doc(user.uid).collection(\"chats\").doc(roomId).set({\n        name: room.name,\n        photoURL: room.photoURL || null,\n        timestamp: createTimestamp()\n      });\n      const doc = await db.collection(\"rooms\").doc(roomId).collection(\"messages\").add(newMessage);\n\n      if (image) {\n        new Compressor(image, {\n          quality: 0.8,\n          maxWidth: 1920,\n\n          async success(result) {\n            setSrc(\"\");\n            setImage(null);\n            await storage.child(imageName).put(result);\n            const url = await storage.child(imageName).getDownloadURL();\n            db.collection(\"rooms\").doc(roomId).collection(\"messages\").doc(doc.id).update({\n              imageUrl: url\n            });\n          }\n\n        });\n      }\n    }\n  }\n\n  function showPreview(event) {\n    const file = event.target.files[0];\n\n    if (file) {\n      setImage(file);\n      const reader = new FileReader();\n      reader.readAsDataURL(file);\n\n      reader.onload = () => {\n        setSrc(reader.result);\n      };\n    }\n  }\n\n  function closePreview() {\n    setSrc(\"\");\n    setImage(null);\n  }\n\n  async function deleteRoom() {\n    setOpenMenu(false);\n    setDeleting(true);\n\n    try {\n      const roomRef = db.collection(\"rooms\").doc(roomId);\n      const roomMessages = await roomRef.collection(\"messages\").get();\n      const audioFiles = [];\n      const imageFiles = [];\n      roomMessages.docs.forEach(doc => {\n        if (doc.data().audioName) {\n          audioFiles.push(doc.data().audioName);\n        } else if (doc.data().imageName) {\n          imageFiles.push(doc.data().imageName);\n        }\n      });\n      await Promise.all([...roomMessages.docs.map(doc => doc.ref.delete()), ...imageFiles.map(image => storage.child(image).delete()), ...audioFiles.map(audio => audioStorage.child(audio).delete()), db.collection(\"users\").doc(user.uid).collection(\"chats\").doc(roomId).delete(), roomRef.delete()]);\n    } catch (error) {\n      console.error(\"Error deleting room: \", error.message);\n    } finally {\n      setDeleting(false);\n      page.isMobile ? history.goBack() : history.replace(\"/chats\");\n    }\n  }\n\n  return /*#__PURE__*/_jsxDEV(\"div\", {\n    className: \"chat\",\n    children: [/*#__PURE__*/_jsxDEV(\"div\", {\n      style: {\n        height: page.height\n      },\n      className: \"chat__background\"\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 160,\n      columnNumber: 7\n    }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n      className: \"chat__header\",\n      children: [page.isMobile && /*#__PURE__*/_jsxDEV(IconButton, {\n        onClick: history.goBack,\n        children: /*#__PURE__*/_jsxDEV(ArrowBack, {}, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 165,\n          columnNumber: 13\n        }, this)\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 164,\n        columnNumber: 11\n      }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n        className: \"avatar__container\",\n        children: /*#__PURE__*/_jsxDEV(Avatar, {\n          src: room === null || room === void 0 ? void 0 : room.photoURL\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 170,\n          columnNumber: 11\n        }, this)\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 169,\n        columnNumber: 9\n      }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n        className: \"chat__header--info\",\n        children: /*#__PURE__*/_jsxDEV(\"h3\", {\n          style: {\n            width: page.isMobile && page.width - 165\n          },\n          children: room === null || room === void 0 ? void 0 : room.name\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 174,\n          columnNumber: 11\n        }, this)\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 173,\n        columnNumber: 9\n      }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n        className: \"chat__header--right\",\n        children: [/*#__PURE__*/_jsxDEV(\"input\", {\n          id: \"image\",\n          style: {\n            display: \"none\"\n          },\n          accept: \"image/*\",\n          type: \"file\",\n          onChange: showPreview\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 180,\n          columnNumber: 11\n        }, this), /*#__PURE__*/_jsxDEV(IconButton, {\n          children: /*#__PURE__*/_jsxDEV(\"label\", {\n            style: {\n              cursor: \"pointer\",\n              height: 24\n            },\n            htmlFor: \"image\",\n            children: /*#__PURE__*/_jsxDEV(AddPhotoAlternate, {}, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 189,\n              columnNumber: 15\n            }, this)\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 188,\n            columnNumber: 13\n          }, this)\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 187,\n          columnNumber: 11\n        }, this), /*#__PURE__*/_jsxDEV(IconButton, {\n          onClick: event => setOpenMenu(event.currentTarget),\n          children: /*#__PURE__*/_jsxDEV(MoreVert, {}, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 193,\n            columnNumber: 13\n          }, this)\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 192,\n          columnNumber: 11\n        }, this), /*#__PURE__*/_jsxDEV(Menu, {\n          id: \"menu\",\n          anchorEl: openMenu,\n          open: Boolean(openMenu),\n          onClose: () => setOpenMenu(null),\n          keepMounted: true,\n          children: /*#__PURE__*/_jsxDEV(MenuItem, {\n            onClick: deleteRoom,\n            children: \"Delete Room\"\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 202,\n            columnNumber: 13\n          }, this)\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 195,\n          columnNumber: 11\n        }, this)]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 179,\n        columnNumber: 9\n      }, this)]\n    }, void 0, true, {\n      fileName: _jsxFileName,\n      lineNumber: 162,\n      columnNumber: 7\n    }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n      className: \"chat__body--container\",\n      children: /*#__PURE__*/_jsxDEV(\"div\", {\n        className: \"chat__body\",\n        style: {\n          height: page.height - 68\n        },\n        children: /*#__PURE__*/_jsxDEV(ChatMessages, {\n          messages: messages,\n          user: user,\n          roomId: roomId,\n          audioId: audioId,\n          setAudioId: setAudioId\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 209,\n          columnNumber: 11\n        }, this)\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 208,\n        columnNumber: 9\n      }, this)\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 207,\n      columnNumber: 7\n    }, this), /*#__PURE__*/_jsxDEV(MediaPreview, {\n      src: src,\n      closePreview: closePreview\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 219,\n      columnNumber: 7\n    }, this), /*#__PURE__*/_jsxDEV(ChatFooter, {\n      input: input,\n      onChange: onChange,\n      sendMessage: sendMessage,\n      image: image,\n      user: user,\n      room: room,\n      roomId: roomId,\n      setAudioId: setAudioId\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 221,\n      columnNumber: 7\n    }, this), isDeleting && /*#__PURE__*/_jsxDEV(\"div\", {\n      className: \"chat__deleting\",\n      children: /*#__PURE__*/_jsxDEV(CircularProgress, {}, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 234,\n        columnNumber: 11\n      }, this)\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 233,\n      columnNumber: 9\n    }, this)]\n  }, void 0, true, {\n    fileName: _jsxFileName,\n    lineNumber: 159,\n    columnNumber: 5\n  }, this);\n}\n\n_s(Chat, \"XUJmW8LRuOmAQLmFQkuJNTLSV7k=\", false, function () {\n  return [useParams, useHistory, useChatMessages, useRoom];\n});\n\n_c = Chat;\n\nvar _c;\n\n$RefreshReg$(_c, \"Chat\");","map":{"version":3,"sources":["C:/Users/Koosha/Desktop/Reed Barger - Build WhatsApp with React 2021-5/whatsapp-clone/src/components/Chat.js"],"names":["React","useHistory","useParams","useRoom","ChatMessages","ChatFooter","MediaPreview","Compressor","Avatar","CircularProgress","IconButton","Menu","MenuItem","AddPhotoAlternate","ArrowBack","MoreVert","v4","uuid","audioStorage","createTimestamp","db","storage","useChatMessages","Chat","user","page","image","setImage","useState","input","setInput","isDeleting","setDeleting","openMenu","setOpenMenu","src","setSrc","audioId","setAudioId","roomId","history","messages","room","uid","onChange","event","target","value","sendMessage","preventDefault","trim","closePreview","imageName","newMessage","name","displayName","message","timestamp","time","Date","toUTCString","imageUrl","collection","doc","set","photoURL","add","quality","maxWidth","success","result","child","put","url","getDownloadURL","id","update","showPreview","file","files","reader","FileReader","readAsDataURL","onload","deleteRoom","roomRef","roomMessages","get","audioFiles","imageFiles","docs","forEach","data","audioName","push","Promise","all","map","ref","delete","audio","error","console","isMobile","goBack","replace","height","width","display","cursor","currentTarget","Boolean"],"mappings":"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","sourcesContent":["import React from \"react\";\nimport { useHistory, useParams } from \"react-router-dom\";\nimport \"./Chat.css\";\nimport useRoom from \"../hooks/useRoom\";\nimport ChatMessages from \"./ChatMessages\";\nimport ChatFooter from \"./ChatFooter\";\nimport MediaPreview from \"./MediaPreview\";\nimport Compressor from \"compressorjs\";\nimport {\n  Avatar,\n  CircularProgress,\n  IconButton,\n  Menu,\n  MenuItem,\n} from \"@material-ui/core\";\nimport { AddPhotoAlternate, ArrowBack, MoreVert } from \"@material-ui/icons\";\nimport { v4 as uuid } from \"uuid\";\nimport { audioStorage, createTimestamp, db, storage } from \"../firebase\";\nimport useChatMessages from \"../hooks/useChatMessages\";\n\nexport default function Chat({ user, page }) {\n  const [image, setImage] = React.useState(null);\n  const [input, setInput] = React.useState(\"\");\n  const [isDeleting, setDeleting] = React.useState(false);\n  const [openMenu, setOpenMenu] = React.useState(null);\n  const [src, setSrc] = React.useState(\"\");\n  const [audioId, setAudioId] = React.useState(\"\");\n\n  const { roomId } = useParams();\n  const history = useHistory();\n  const messages = useChatMessages(roomId);\n  const room = useRoom(roomId, user.uid);\n\n  function onChange(event) {\n    setInput(event.target.value);\n  }\n\n  async function sendMessage(event) {\n    event.preventDefault();\n\n    if (input.trim() || (input === \"\" && image)) {\n      setInput(\"\");\n      if (image) {\n        closePreview();\n      }\n      const imageName = uuid();\n      const newMessage = image\n        ? {\n            name: user.displayName,\n            message: input,\n            uid: user.uid,\n            timestamp: createTimestamp(),\n            time: new Date().toUTCString(),\n            imageUrl: \"uploading\",\n            imageName,\n          }\n        : {\n            name: user.displayName,\n            message: input,\n            uid: user.uid,\n            timestamp: createTimestamp(),\n            time: new Date().toUTCString(),\n          };\n\n      db.collection(\"users\")\n        .doc(user.uid)\n        .collection(\"chats\")\n        .doc(roomId)\n        .set({\n          name: room.name,\n          photoURL: room.photoURL || null,\n          timestamp: createTimestamp(),\n        });\n\n      const doc = await db\n        .collection(\"rooms\")\n        .doc(roomId)\n        .collection(\"messages\")\n        .add(newMessage);\n\n      if (image) {\n        new Compressor(image, {\n          quality: 0.8,\n          maxWidth: 1920,\n          async success(result) {\n            setSrc(\"\");\n            setImage(null);\n            await storage.child(imageName).put(result);\n            const url = await storage.child(imageName).getDownloadURL();\n            db.collection(\"rooms\")\n              .doc(roomId)\n              .collection(\"messages\")\n              .doc(doc.id)\n              .update({\n                imageUrl: url,\n              });\n          },\n        });\n      }\n    }\n  }\n\n  function showPreview(event) {\n    const file = event.target.files[0];\n\n    if (file) {\n      setImage(file);\n      const reader = new FileReader();\n      reader.readAsDataURL(file);\n      reader.onload = () => {\n        setSrc(reader.result);\n      };\n    }\n  }\n\n  function closePreview() {\n    setSrc(\"\");\n    setImage(null);\n  }\n\n  async function deleteRoom() {\n    setOpenMenu(false);\n    setDeleting(true);\n\n    try {\n      const roomRef = db.collection(\"rooms\").doc(roomId);\n      const roomMessages = await roomRef.collection(\"messages\").get();\n      const audioFiles = [];\n      const imageFiles = [];\n      roomMessages.docs.forEach((doc) => {\n        if (doc.data().audioName) {\n          audioFiles.push(doc.data().audioName);\n        } else if (doc.data().imageName) {\n          imageFiles.push(doc.data().imageName);\n        }\n      });\n\n      await Promise.all([\n        ...roomMessages.docs.map((doc) => doc.ref.delete()),\n        ...imageFiles.map((image) => storage.child(image).delete()),\n        ...audioFiles.map((audio) => audioStorage.child(audio).delete()),\n        db\n          .collection(\"users\")\n          .doc(user.uid)\n          .collection(\"chats\")\n          .doc(roomId)\n          .delete(),\n        roomRef.delete(),\n      ]);\n    } catch (error) {\n      console.error(\"Error deleting room: \", error.message);\n    } finally {\n      setDeleting(false);\n      page.isMobile ? history.goBack() : history.replace(\"/chats\");\n    }\n  }\n\n  return (\n    <div className=\"chat\">\n      <div style={{ height: page.height }} className=\"chat__background\" />\n\n      <div className=\"chat__header\">\n        {page.isMobile && (\n          <IconButton onClick={history.goBack}>\n            <ArrowBack />\n          </IconButton>\n        )}\n\n        <div className=\"avatar__container\">\n          <Avatar src={room?.photoURL} />\n        </div>\n\n        <div className=\"chat__header--info\">\n          <h3 style={{ width: page.isMobile && page.width - 165 }}>\n            {room?.name}\n          </h3>\n        </div>\n\n        <div className=\"chat__header--right\">\n          <input\n            id=\"image\"\n            style={{ display: \"none\" }}\n            accept=\"image/*\"\n            type=\"file\"\n            onChange={showPreview}\n          />\n          <IconButton>\n            <label style={{ cursor: \"pointer\", height: 24 }} htmlFor=\"image\">\n              <AddPhotoAlternate />\n            </label>\n          </IconButton>\n          <IconButton onClick={(event) => setOpenMenu(event.currentTarget)}>\n            <MoreVert />\n          </IconButton>\n          <Menu\n            id=\"menu\"\n            anchorEl={openMenu}\n            open={Boolean(openMenu)}\n            onClose={() => setOpenMenu(null)}\n            keepMounted\n          >\n            <MenuItem onClick={deleteRoom}>Delete Room</MenuItem>\n          </Menu>\n        </div>\n      </div>\n\n      <div className=\"chat__body--container\">\n        <div className=\"chat__body\" style={{ height: page.height - 68 }}>\n          <ChatMessages\n            messages={messages}\n            user={user}\n            roomId={roomId}\n            audioId={audioId}\n            setAudioId={setAudioId}\n          />\n        </div>\n      </div>\n\n      <MediaPreview src={src} closePreview={closePreview} />\n\n      <ChatFooter\n        input={input}\n        onChange={onChange}\n        sendMessage={sendMessage}\n        image={image}\n        user={user}\n        room={room}\n        roomId={roomId}\n        setAudioId={setAudioId}\n      />\n\n      {isDeleting && (\n        <div className=\"chat__deleting\">\n          <CircularProgress />\n        </div>\n      )}\n    </div>\n  );\n}\n"]},"metadata":{},"sourceType":"module"}