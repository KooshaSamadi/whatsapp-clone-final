{"ast":null,"code":"import _toConsumableArray from\"C:/Users/Koosha/Desktop/Reed Barger - Build WhatsApp with React 2021-5/whatsapp-clone/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/toConsumableArray\";import _regeneratorRuntime from\"C:/Users/Koosha/Desktop/Reed Barger - Build WhatsApp with React 2021-5/whatsapp-clone/node_modules/babel-preset-react-app/node_modules/@babel/runtime/regenerator\";import _asyncToGenerator from\"C:/Users/Koosha/Desktop/Reed Barger - Build WhatsApp with React 2021-5/whatsapp-clone/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";import _slicedToArray from\"C:/Users/Koosha/Desktop/Reed Barger - Build WhatsApp with React 2021-5/whatsapp-clone/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/slicedToArray\";import React from\"react\";import{useHistory,useParams}from\"react-router-dom\";import\"./Chat.css\";import useRoom from\"../hooks/useRoom\";import ChatMessages from\"./ChatMessages\";import ChatFooter from\"./ChatFooter\";import MediaPreview from\"./MediaPreview\";import Compressor from\"compressorjs\";import{Avatar,CircularProgress,IconButton,Menu,MenuItem}from\"@material-ui/core\";import{AddPhotoAlternate,ArrowBack,MoreVert}from\"@material-ui/icons\";import{v4 as uuid}from\"uuid\";import{audioStorage,createTimestamp,db,storage}from\"../firebase\";import useChatMessages from\"../hooks/useChatMessages\";import{jsx as _jsx}from\"react/jsx-runtime\";import{jsxs as _jsxs}from\"react/jsx-runtime\";export default function Chat(_ref){var user=_ref.user,page=_ref.page;var _React$useState=React.useState(null),_React$useState2=_slicedToArray(_React$useState,2),image=_React$useState2[0],setImage=_React$useState2[1];var _React$useState3=React.useState(\"\"),_React$useState4=_slicedToArray(_React$useState3,2),input=_React$useState4[0],setInput=_React$useState4[1];var _React$useState5=React.useState(false),_React$useState6=_slicedToArray(_React$useState5,2),isDeleting=_React$useState6[0],setDeleting=_React$useState6[1];var _React$useState7=React.useState(null),_React$useState8=_slicedToArray(_React$useState7,2),openMenu=_React$useState8[0],setOpenMenu=_React$useState8[1];var _React$useState9=React.useState(\"\"),_React$useState10=_slicedToArray(_React$useState9,2),src=_React$useState10[0],setSrc=_React$useState10[1];var _React$useState11=React.useState(\"\"),_React$useState12=_slicedToArray(_React$useState11,2),audioId=_React$useState12[0],setAudioId=_React$useState12[1];var _useParams=useParams(),roomId=_useParams.roomId;var history=useHistory();var messages=useChatMessages(roomId);var room=useRoom(roomId,user.uid);function onChange(event){setInput(event.target.value);}function sendMessage(_x){return _sendMessage.apply(this,arguments);}function _sendMessage(){_sendMessage=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(event){var imageName,newMessage,doc;return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:event.preventDefault();if(!(input.trim()||input===\"\"&&image)){_context2.next=11;break;}setInput(\"\");if(image){closePreview();}imageName=uuid();newMessage=image?{name:user.displayName,message:input,uid:user.uid,timestamp:createTimestamp(),time:new Date().toUTCString(),imageUrl:\"uploading\",imageName:imageName}:{name:user.displayName,message:input,uid:user.uid,timestamp:createTimestamp(),time:new Date().toUTCString()};db.collection(\"users\").doc(user.uid).collection(\"chats\").doc(roomId).set({name:room.name,photoURL:room.photoURL||null,timestamp:createTimestamp()});_context2.next=9;return db.collection(\"rooms\").doc(roomId).collection(\"messages\").add(newMessage);case 9:doc=_context2.sent;if(image){new Compressor(image,{quality:0.8,maxWidth:1920,success:function success(result){return _asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(){var url;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:setSrc(\"\");setImage(null);_context.next=4;return storage.child(imageName).put(result);case 4:_context.next=6;return storage.child(imageName).getDownloadURL();case 6:url=_context.sent;db.collection(\"rooms\").doc(roomId).collection(\"messages\").doc(doc.id).update({imageUrl:url});case 8:case\"end\":return _context.stop();}}},_callee);}))();}});}case 11:case\"end\":return _context2.stop();}}},_callee2);}));return _sendMessage.apply(this,arguments);}function showPreview(event){var file=event.target.files[0];if(file){setImage(file);var reader=new FileReader();reader.readAsDataURL(file);reader.onload=function(){setSrc(reader.result);};}}function closePreview(){setSrc(\"\");setImage(null);}function deleteRoom(){return _deleteRoom.apply(this,arguments);}function _deleteRoom(){_deleteRoom=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee3(){var roomRef,roomMessages,audioFiles,imageFiles;return _regeneratorRuntime.wrap(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:setOpenMenu(false);setDeleting(true);_context3.prev=2;roomRef=db.collection(\"rooms\").doc(roomId);_context3.next=6;return roomRef.collection(\"messages\").get();case 6:roomMessages=_context3.sent;audioFiles=[];imageFiles=[];roomMessages.docs.forEach(function(doc){if(doc.data().audioName){audioFiles.push(doc.data().audioName);}else if(doc.data().imageName){imageFiles.push(doc.data().imageName);}});_context3.next=12;return Promise.all([].concat(_toConsumableArray(roomMessages.docs.map(function(doc){return doc.ref.delete();})),_toConsumableArray(imageFiles.map(function(image){return storage.child(image).delete();})),_toConsumableArray(audioFiles.map(function(audio){return audioStorage.child(audio).delete();})),[db.collection(\"users\").doc(user.uid).collection(\"chats\").doc(roomId).delete(),roomRef.delete()]));case 12:_context3.next=17;break;case 14:_context3.prev=14;_context3.t0=_context3[\"catch\"](2);console.error(\"Error deleting room: \",_context3.t0.message);case 17:_context3.prev=17;setDeleting(false);page.isMobile?history.goBack():history.replace(\"/chats\");return _context3.finish(17);case 21:case\"end\":return _context3.stop();}}},_callee3,null,[[2,14,17,21]]);}));return _deleteRoom.apply(this,arguments);}return/*#__PURE__*/_jsxs(\"div\",{className:\"chat\",children:[/*#__PURE__*/_jsx(\"div\",{style:{height:page.height},className:\"chat__background\"}),/*#__PURE__*/_jsxs(\"div\",{className:\"chat__header\",children:[page.isMobile&&/*#__PURE__*/_jsx(IconButton,{onClick:history.goBack,children:/*#__PURE__*/_jsx(ArrowBack,{})}),/*#__PURE__*/_jsx(\"div\",{className:\"avatar__container\",children:/*#__PURE__*/_jsx(Avatar,{src:room===null||room===void 0?void 0:room.photoURL})}),/*#__PURE__*/_jsx(\"div\",{className:\"chat__header--info\",children:/*#__PURE__*/_jsx(\"h3\",{style:{width:page.isMobile&&page.width-165},children:room===null||room===void 0?void 0:room.name})}),/*#__PURE__*/_jsxs(\"div\",{className:\"chat__header--right\",children:[/*#__PURE__*/_jsx(\"input\",{id:\"image\",style:{display:\"none\"},accept:\"image/*\",type:\"file\",onChange:showPreview}),/*#__PURE__*/_jsx(IconButton,{children:/*#__PURE__*/_jsx(\"label\",{style:{cursor:\"pointer\",height:24},htmlFor:\"image\",children:/*#__PURE__*/_jsx(AddPhotoAlternate,{})})}),/*#__PURE__*/_jsx(IconButton,{onClick:function onClick(event){return setOpenMenu(event.currentTarget);},children:/*#__PURE__*/_jsx(MoreVert,{})}),/*#__PURE__*/_jsx(Menu,{id:\"menu\",anchorEl:openMenu,open:Boolean(openMenu),onClose:function onClose(){return setOpenMenu(null);},keepMounted:true,children:/*#__PURE__*/_jsx(MenuItem,{onClick:deleteRoom,children:\"Delete Room\"})})]})]}),/*#__PURE__*/_jsx(\"div\",{className:\"chat__body--container\",children:/*#__PURE__*/_jsx(\"div\",{className:\"chat__body\",style:{height:page.height-68},children:/*#__PURE__*/_jsx(ChatMessages,{messages:messages,user:user,roomId:roomId,audioId:audioId,setAudioId:setAudioId})})}),/*#__PURE__*/_jsx(MediaPreview,{src:src,closePreview:closePreview}),/*#__PURE__*/_jsx(ChatFooter,{input:input,onChange:onChange,sendMessage:sendMessage,image:image,user:user,room:room,roomId:roomId,setAudioId:setAudioId}),isDeleting&&/*#__PURE__*/_jsx(\"div\",{className:\"chat__deleting\",children:/*#__PURE__*/_jsx(CircularProgress,{})})]});}","map":{"version":3,"sources":["C:/Users/Koosha/Desktop/Reed Barger - Build WhatsApp with React 2021-5/whatsapp-clone/src/components/Chat.js"],"names":["React","useHistory","useParams","useRoom","ChatMessages","ChatFooter","MediaPreview","Compressor","Avatar","CircularProgress","IconButton","Menu","MenuItem","AddPhotoAlternate","ArrowBack","MoreVert","v4","uuid","audioStorage","createTimestamp","db","storage","useChatMessages","Chat","user","page","useState","image","setImage","input","setInput","isDeleting","setDeleting","openMenu","setOpenMenu","src","setSrc","audioId","setAudioId","roomId","history","messages","room","uid","onChange","event","target","value","sendMessage","preventDefault","trim","closePreview","imageName","newMessage","name","displayName","message","timestamp","time","Date","toUTCString","imageUrl","collection","doc","set","photoURL","add","quality","maxWidth","success","result","child","put","getDownloadURL","url","id","update","showPreview","file","files","reader","FileReader","readAsDataURL","onload","deleteRoom","roomRef","get","roomMessages","audioFiles","imageFiles","docs","forEach","data","audioName","push","Promise","all","map","ref","delete","audio","console","error","isMobile","goBack","replace","height","width","display","cursor","currentTarget","Boolean"],"mappings":"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","sourcesContent":["import React from \"react\";\nimport { useHistory, useParams } from \"react-router-dom\";\nimport \"./Chat.css\";\nimport useRoom from \"../hooks/useRoom\";\nimport ChatMessages from \"./ChatMessages\";\nimport ChatFooter from \"./ChatFooter\";\nimport MediaPreview from \"./MediaPreview\";\nimport Compressor from \"compressorjs\";\nimport {\n  Avatar,\n  CircularProgress,\n  IconButton,\n  Menu,\n  MenuItem,\n} from \"@material-ui/core\";\nimport { AddPhotoAlternate, ArrowBack, MoreVert } from \"@material-ui/icons\";\nimport { v4 as uuid } from \"uuid\";\nimport { audioStorage, createTimestamp, db, storage } from \"../firebase\";\nimport useChatMessages from \"../hooks/useChatMessages\";\n\nexport default function Chat({ user, page }) {\n  const [image, setImage] = React.useState(null);\n  const [input, setInput] = React.useState(\"\");\n  const [isDeleting, setDeleting] = React.useState(false);\n  const [openMenu, setOpenMenu] = React.useState(null);\n  const [src, setSrc] = React.useState(\"\");\n  const [audioId, setAudioId] = React.useState(\"\");\n\n  const { roomId } = useParams();\n  const history = useHistory();\n  const messages = useChatMessages(roomId);\n  const room = useRoom(roomId, user.uid);\n\n  function onChange(event) {\n    setInput(event.target.value);\n  }\n\n  async function sendMessage(event) {\n    event.preventDefault();\n\n    if (input.trim() || (input === \"\" && image)) {\n      setInput(\"\");\n      if (image) {\n        closePreview();\n      }\n      const imageName = uuid();\n      const newMessage = image\n        ? {\n            name: user.displayName,\n            message: input,\n            uid: user.uid,\n            timestamp: createTimestamp(),\n            time: new Date().toUTCString(),\n            imageUrl: \"uploading\",\n            imageName,\n          }\n        : {\n            name: user.displayName,\n            message: input,\n            uid: user.uid,\n            timestamp: createTimestamp(),\n            time: new Date().toUTCString(),\n          };\n\n      db.collection(\"users\")\n        .doc(user.uid)\n        .collection(\"chats\")\n        .doc(roomId)\n        .set({\n          name: room.name,\n          photoURL: room.photoURL || null,\n          timestamp: createTimestamp(),\n        });\n\n      const doc = await db\n        .collection(\"rooms\")\n        .doc(roomId)\n        .collection(\"messages\")\n        .add(newMessage);\n\n      if (image) {\n        new Compressor(image, {\n          quality: 0.8,\n          maxWidth: 1920,\n          async success(result) {\n            setSrc(\"\");\n            setImage(null);\n            await storage.child(imageName).put(result);\n            const url = await storage.child(imageName).getDownloadURL();\n            db.collection(\"rooms\")\n              .doc(roomId)\n              .collection(\"messages\")\n              .doc(doc.id)\n              .update({\n                imageUrl: url,\n              });\n          },\n        });\n      }\n    }\n  }\n\n  function showPreview(event) {\n    const file = event.target.files[0];\n\n    if (file) {\n      setImage(file);\n      const reader = new FileReader();\n      reader.readAsDataURL(file);\n      reader.onload = () => {\n        setSrc(reader.result);\n      };\n    }\n  }\n\n  function closePreview() {\n    setSrc(\"\");\n    setImage(null);\n  }\n\n  async function deleteRoom() {\n    setOpenMenu(false);\n    setDeleting(true);\n\n    try {\n      const roomRef = db.collection(\"rooms\").doc(roomId);\n      const roomMessages = await roomRef.collection(\"messages\").get();\n      const audioFiles = [];\n      const imageFiles = [];\n      roomMessages.docs.forEach((doc) => {\n        if (doc.data().audioName) {\n          audioFiles.push(doc.data().audioName);\n        } else if (doc.data().imageName) {\n          imageFiles.push(doc.data().imageName);\n        }\n      });\n\n      await Promise.all([\n        ...roomMessages.docs.map((doc) => doc.ref.delete()),\n        ...imageFiles.map((image) => storage.child(image).delete()),\n        ...audioFiles.map((audio) => audioStorage.child(audio).delete()),\n        db\n          .collection(\"users\")\n          .doc(user.uid)\n          .collection(\"chats\")\n          .doc(roomId)\n          .delete(),\n        roomRef.delete(),\n      ]);\n    } catch (error) {\n      console.error(\"Error deleting room: \", error.message);\n    } finally {\n      setDeleting(false);\n      page.isMobile ? history.goBack() : history.replace(\"/chats\");\n    }\n  }\n\n  return (\n    <div className=\"chat\">\n      <div style={{ height: page.height }} className=\"chat__background\" />\n\n      <div className=\"chat__header\">\n        {page.isMobile && (\n          <IconButton onClick={history.goBack}>\n            <ArrowBack />\n          </IconButton>\n        )}\n\n        <div className=\"avatar__container\">\n          <Avatar src={room?.photoURL} />\n        </div>\n\n        <div className=\"chat__header--info\">\n          <h3 style={{ width: page.isMobile && page.width - 165 }}>\n            {room?.name}\n          </h3>\n        </div>\n\n        <div className=\"chat__header--right\">\n          <input\n            id=\"image\"\n            style={{ display: \"none\" }}\n            accept=\"image/*\"\n            type=\"file\"\n            onChange={showPreview}\n          />\n          <IconButton>\n            <label style={{ cursor: \"pointer\", height: 24 }} htmlFor=\"image\">\n              <AddPhotoAlternate />\n            </label>\n          </IconButton>\n          <IconButton onClick={(event) => setOpenMenu(event.currentTarget)}>\n            <MoreVert />\n          </IconButton>\n          <Menu\n            id=\"menu\"\n            anchorEl={openMenu}\n            open={Boolean(openMenu)}\n            onClose={() => setOpenMenu(null)}\n            keepMounted\n          >\n            <MenuItem onClick={deleteRoom}>Delete Room</MenuItem>\n          </Menu>\n        </div>\n      </div>\n\n      <div className=\"chat__body--container\">\n        <div className=\"chat__body\" style={{ height: page.height - 68 }}>\n          <ChatMessages\n            messages={messages}\n            user={user}\n            roomId={roomId}\n            audioId={audioId}\n            setAudioId={setAudioId}\n          />\n        </div>\n      </div>\n\n      <MediaPreview src={src} closePreview={closePreview} />\n\n      <ChatFooter\n        input={input}\n        onChange={onChange}\n        sendMessage={sendMessage}\n        image={image}\n        user={user}\n        room={room}\n        roomId={roomId}\n        setAudioId={setAudioId}\n      />\n\n      {isDeleting && (\n        <div className=\"chat__deleting\">\n          <CircularProgress />\n        </div>\n      )}\n    </div>\n  );\n}\n"]},"metadata":{},"sourceType":"module"}